# Group Members:
# Mou Rani Biswas - 398778
# MD Saifur Rahman - 398921
# Nahid Hasan Sangram - 395231
# Mohammed Rifatul Alam - 399533
#
# HIT137 Assignment 2
# Question 2 – Part 1: Seasonal average temperatures (ignore NaN)
 
import glob
import os
import pandas as pd
 
MONTHS = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
]
 
SEASON_BY_MONTH = {
    "December": "Summer", "January": "Summer", "February": "Summer",
    "March": "Autumn", "April": "Autumn", "May": "Autumn",
    "June": "Winter", "July": "Winter", "August": "Winter",
    "September": "Spring", "October": "Spring", "November": "Spring",
}
 
SEASON_ORDER = ["Summer", "Autumn", "Winter", "Spring"]
 
 
def load_all_csvs(temps_dir: str) -> pd.DataFrame:
    pattern = os.path.join(temps_dir, "*.csv")
    files = sorted(glob.glob(pattern))
    if not files:
        raise FileNotFoundError(f"No CSV files found in: {temps_dir}")
 
    frames = []
    required = ["STATION_NAME", "STN_ID"] + MONTHS
 
    for fp in files:
        df = pd.read_csv(fp)
 
        missing = [c for c in required if c not in df.columns]
        if missing:
            raise ValueError(f"{os.path.basename(fp)} missing columns: {missing}")
 
        df = df[required].copy()
 
        # convert monthly values to numeric, keep NaN as NaN
        for m in MONTHS:
            df[m] = pd.to_numeric(df[m], errors="coerce")
 
        frames.append(df)
 
    return pd.concat(frames, ignore_index=True)
 
 
def compute_seasonal_averages(all_data: pd.DataFrame) -> dict:
    # wide -> long (Month, Temp)
    long_df = all_data.melt(
        id_vars=["STATION_NAME", "STN_ID"],
        value_vars=MONTHS,
        var_name="Month",
        value_name="Temp"
    )
 
    long_df["Season"] = long_df["Month"].map(SEASON_BY_MONTH)
 
    # Ignore NaN and compute mean per season
    season_means = (
        long_df.dropna(subset=["Temp"])
              .groupby("Season")["Temp"]
              .mean()
              .to_dict()
    )
 
    # return in fixed order
    return {s: float(season_means.get(s, float("nan"))) for s in SEASON_ORDER}
 
 
def write_average_temp(out_path: str, season_means: dict) -> None:
    with open(out_path, "w", encoding="utf-8") as f:
        for season in SEASON_ORDER:
            f.write(f"{season}: {season_means[season]:.1f}°C\n")
 
 
def main():
    here = os.path.dirname(os.path.abspath(__file__))
    temps_dir = os.path.join(here, "temperatures")
 
    all_data = load_all_csvs(temps_dir)
    season_means = compute_seasonal_averages(all_data)
 
    out_file = os.path.join(here, "average_temp.txt")
    write_average_temp(out_file, season_means)
 
    print(" Q2 Part 1 complete: average_temp.txt generated.")
 
 
if __name__ == "__main__":
    main()